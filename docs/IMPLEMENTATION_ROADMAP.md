# Unified Orchestrator Roadmap – What To Build and How

Audience
- Other LLMs and human contributors. This is the living blueprint for continuing the in-place refactor to a modular, config-driven system, while keeping the product usable.

Goals (Why)
- Keep brand-builder-16-oct as the product core; evolve architecture in-place.
- Make every step legible to LLMs and non-coders.
- Preserve determinism, evidence, and change isolation.

Guiding Principles (How)
- Stateless agents, config-as-code (`config/workflow.json`), single-responsibility modules.
- No file I/O in agents; CLI/orchestrators own persistence.
- Agent names are stable; new behavior is new agents, not rewrites.
- Optional integrations (ORACLE, SPA rendering) are gated by flags.

Deliverables (What)
1) Orchestrator v1.1 – Resume + Manifest
- Add run manifest and resume capability to config orchestrator.
- Files:
  - `src/orchestrator/config-orchestrator.ts` (manifest write, resume strategy)
  - `src/cli/commands/workflow.ts` (flags: `--resume`, `--force`, final summary)
  - `outputs/evolution/<brand>/run-manifest.json` (see Format below)
- Format (run-manifest.json):
```
{
  "brand": "acme",
  "startedAt": "ISO",
  "finishedAt": "ISO",
  "stages": [
    {
      "name": "Discovery",
      "agents": [
        { "name": "evolution.research-blitz", "status": "success|error|skipped", "output": ["01-research-blitz.json"] },
        { "name": "evolution.pattern-presentation", "status": "success|error|skipped", "output": ["02-patterns.json", "02-patterns.md"] }
      ]
    }
  ],
  "metrics": { "totalMs": 0, "llm": { "calls": 0, "errors": 0 } }
}
```
- Acceptance:
  - `--resume` skips agents whose output files already exist.
  - `--force` re-runs the last agent even if outputs exist.
  - CLI prints a final success/fail summary by agent.

2) Agents v2 – Migrate Phases 3–5
- Convert remaining phases to agents with typed results:
  - `evolution.creative-direction` (03-creative-direction.json / .md)
  - `evolution.validation` (04-validation.json / .md)
  - `evolution.build-out` (05-buildout.json / 05-brand-evolution-strategy.md)
- Files:
  - `src/agents/evolution/creative-direction-agent.ts`
  - `src/agents/evolution/validation-agent.ts`
  - `src/agents/evolution/build-out-agent.ts`
  - `src/orchestrator/AgentFactory.ts` (register)
  - `config/workflow.json` (append agents)
- Acceptance:
  - Each agent returns valid typed output matching existing evolution outputs.
  - Markdown artifacts are generated by CLI (not inside agents).

3) Typed Results Registry
- Replace `Record<string, unknown>` with a typed mapping of agent name → result type.
- Files:
  - `src/agents/IAgent.ts` (generic `IAgentResult<T>` stays)
  - `src/types/agent-results.ts` (mapping interface)
  - `src/orchestrator/config-orchestrator.ts` (type-aware `shared.results`)
- Acceptance:
  - Type-check fails when a consumer reads an agent output with the wrong type.

4) HTML Report (Executive)
- Combine 01–05 artifacts into a single self-contained HTML report.
- Files:
  - `src/presentation/report-builder.ts` (pure function)
  - CLI: `brandos workflow report --brand <name>`
- Acceptance:
  - Generates a single HTML at `outputs/evolution/<brand>/brand-report.html`.

5) UX – Setup & Use
- Reduce friction for non-coders.
- Files:
  - `src/cli/commands/setup.ts` (API keys, defaults, workspace creation)
  - `src/cli/commands/use.ts` (persist current brand context)
  - `src/cli/utils/context.ts` (read/write active brand)
- Acceptance:
  - After `brandos use -b Acme`, commands don’t require `--brand`.

6) SPA Rendering (Optional)
- Playwright-backed fetch behind `--render` flag.
- Files:
  - `src/utils/web-fetcher.ts` (strategy param: `basic|rendered`)
  - CLI flag passthrough (workflow & evolve)
- Acceptance:
  - When `--render`, research phase uses rendered DOM for JS-heavy sites.

7) ORACLE Gating
- Enforce `features.useOracle` to load Oracle-dependent agents only when enabled.
- Acceptance:
  - Node-only default runs without Python dependencies.

8) Testing & Metrics
- Minimum tests:
  - Workflow validation (invalid JSON, friendly errors)
  - Agent factory resolution and metadata
  - Explain output snapshot
  - Resume behavior (skips when outputs exist)
- Add run metrics summary to the CLI (time per agent, totals).

How To Build (Commands)
- Dev:
```
# Offline, deterministic development
export BRANDOS_OFFLINE=true
npm run dev -- workflow run -- --brand "Acme" --url "https://acme.com" --explain
```
- Build + manifest:
```
npm run build   # postbuild auto-generates docs/agents-manifest.json
```
- Run (installed CLI):
```
brandos workflow run --brand "Acme" --url "https://acme.com" --explain --resume
```

Design Decisions
- Explain-first runs: build trust by printing the plan before executing.
- File-based resume: simple, robust; no DB required.
- Stable outputs: maintain existing 01–05 file names for compatibility.
- Optional integrations off-by-default: faster time-to-value for most users.

Risks & Mitigations
- TS type erosion: add typed results registry to enforce contracts.
- Rate limits: offline mode + retries, circuit breaker; see `docs/BUILD_AND_RATE_LIMITS.md`.
- Over-scope: ship one delight per milestone (resume → agents → HTML → UX).

Definition of Done (Each Milestone)
- Code compiles (strict TS), unit tests for new logic, updated docs, and CLI help text.
- Explain mode shows the correct plan; artifacts saved with expected names.

Appendix – File Map
- Orchestrator: `src/orchestrator/config-orchestrator.ts`
- Factory: `src/orchestrator/AgentFactory.ts`
- Agents: `src/agents/evolution/*`
- CLI: `src/cli/commands/workflow.ts`
- Schema: `config/workflow.schema.json`
- Docs: `docs/LLM_COLLABORATION_GUIDE.md`, `docs/WORKFLOW_CONFIG.md`, `docs/BUILD_AND_RATE_LIMITS.md`

